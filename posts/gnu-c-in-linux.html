<!doctype html>

<html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
<title>Linux &#x4e2d;&#x7684; GNU C&#xff1a;&#x4ee3;&#x7801;&#x89e3;&#x8bfb;</title>
<meta name="generator" content="Nue (nuejs.org)">
<meta name="date.updated" content="2024-01-12T14:03:51.442Z">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Linux &#x4ee3;&#x7801;&#x4e2d;&#x4f7f;&#x7528;&#x4e86;&#x5927;&#x91cf; gcc &#x7684;&#x62d3;&#x5c55;&#x529f;&#x80fd;&#x6765;&#x8865;&#x5145; C &#x7684;&#x8bed;&#x8a00;&#x7279;&#x6027;&#xff0c;&#x5728; C &#x8fd9;&#x4e00;&#x8868;&#x8fbe;&#x80fd;&#x529b;&#x5e76;&#x4e0d;&#x662f;&#x975e;&#x5e38;&#x5f3a;&#x7684;&#x8bed;&#x8a00;&#x4e0a;&#x5b9e;&#x73b0;&#x4e86;&#x5728;&#x5176;&#x4ed6;&#x8bed;&#x8a00;&#x4e2d;&#x901a;&#x5e38;&#x9700;&#x8981;&#x4f7f;&#x7528;&#x8303;&#x578b;&#x624d;&#x80fd;&#x5b9e;&#x73b0;&#x7684;&#x901a;&#x7528;&#x6570;&#x636e;&#x7ed3;&#x6784;&#x3002;&#x8fd9;&#x7bc7;&#x6587;&#x7ae0;&#x5e26;&#x4f60;&#x4e86;&#x89e3; Linux &#x4f7f;&#x7528;&#x4e86;&#x54ea;&#x4e9b;&#x8bed;&#x8a00;&#x548c;&#x7f16;&#x8bd1;&#x5668;&#x7279;&#x6027;&#x6765;&#x5b8c;&#x6210;&#x8fd9;&#x4e00;&#x4efb;&#x52a1;&#x3002;">
<meta property="article:published_time" content="2021-10-22T16:00:00.000Z">
<link rel="shortcut icon" type="image/jpg" src="/img/favicon.jpg">
<link href="/global/global.css" rel="stylesheet">
<link href="/posts/post.css" rel="stylesheet">
<script src="/global/main.js" type="module"></script>
<script src="/@nue/page-router.js" type="module"></script>
    
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,400;8..144,700&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&amp;display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" integrity="sha512-hasIneQUHlh06VNBe7f6ZcHmeRTLIaQWFd43YriJ0UND19bvYRauxthDg8E4eVNPm9bRUhr5JGeqH7FRFXQu5g==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer">

  </head>

  <body>
    <header class="flex">
  <a class="flex homelink" href="/">
    <img alt="Avatar image" width="64" height="64" src="/img/avatar.jpg">
    <strong>Harlan V. Wei (aka. Wei Chen)</strong>
  </a>
  <nav>
    <a target="_blank" href="mailto:contact@harlanwei.com">
      <img class="icon" width="30" height="30" src="/img/email.svg" alt="My Email">
    </a><a target="_blank" href="//twitter.com/imharlanwei">
      <img class="icon" width="30" height="30" src="/img/twitter.svg" alt="Twitter profile">
    </a><a target="_blank" href="//github.com/harlanwei/">
      <img class="icon" width="30" height="30" src="/img/github.svg" alt="Github projects">
    </a><a target="_blank" href="//www.linkedin.com/in/harlanwei/">
      <img class="icon" width="30" height="30" src="/img/linkedin.svg" alt="LinkedIn profile">
    </a>
  </nav>
</header>
    <main lang="zh-Hans">

  <h1>Linux &#x4e2d;&#x7684; GNU C&#xff1a;&#x4ee3;&#x7801;&#x89e3;&#x8bfb;</h1>

  <p>
    <time>October 23, 2021</time>
    <span> &#x2022; Photo credits: <a class="backlit" target="_blank" href="https://unsplash.com/@lukash">Lukas @ Unsplash</a></span>
  </p>

  <img class="hero" style="max-height: 400px; width: 100%; object-fit: cover;" src="https://images.unsplash.com/photo-1640552435388-a54879e72b28?w=640" alt="Hero image for Linux &#x4e2d;&#x7684; GNU C&#xff1a;&#x4ee3;&#x7801;&#x89e3;&#x8bfb;">

  <article>
    <blockquote>
<p>This post is only available in Chinese at this moment.</p>
</blockquote>
<p>&#x8fd9;&#x662f;&#x6211;&#x5728;&#x5b9e;&#x9a8c;&#x5ba4;&#x5b66;&#x4e60;&#x8fc7;&#x7a0b;&#x4e2d;&#x64b0;&#x5199;&#x7684;&#x8bfb;&#x4e66;&#x7b14;&#x8bb0;&#x7684;&#x4e00;&#x90e8;&#x5206;&#x3002;&#x672c;&#x6587;&#x4ee5; Linux &#x4e2d;&#x6bd4;&#x8f83;&#x6709;&#x4ee3;&#x8868;&#x6027;&#x7684;&#x5b8f;&#x4e3a;&#x4f8b;&#xff0c;&#x5411;&#x4f60;&#x4ecb;&#x7ecd; Linux &#x4e2d;&#x7684; GNU C&#x3002;</p>
<h2>__attribute__((packed))</h2>
<p>&#x5047;&#x8bbe;&#x6709;&#x5982;&#x4e0b;&#x4ee3;&#x7801;&#xff1a;</p>
<pre><code class="language-c">struct foo {
    char a;
    int x[z];
} __attribute__((packed));
</code></pre>
<ul>
<li><code>__attribute__</code> &#x662f; gcc &#x7684;&#x4e00;&#x4e2a;&#x4fdd;&#x7559;&#x5b57;&#xff0c;&#x7528;&#x4e8e;&#x4f5c;&#x5c5e;&#x6027;&#x63cf;&#x8ff0;&#x3002;&#x5982;&#x679c;&#x4e0d;&#x4f7f;&#x7528;&#x8fd9;&#x4e2a;&#x4fdd;&#x7559;&#x5b57;&#xff0c;&#x7531;&#x4e8e; gcc &#x4f18;&#x5148;&#x5c0a;&#x91cd;&#x6807;&#x51c6; C&#xff0c;&#x5219;&#x4f1a;&#x521b;&#x5efa;&#x4e00;&#x4e2a;&#x540d;&#x4e3a; <code>packed</code> &#x7684;&#x53d8;&#x91cf;&#x3002;</li>
<li><code>packed</code> &#x5c5e;&#x6027;&#x8868;&#x793a;&#x5173;&#x95ed;&#x7f16;&#x8bd1;&#x5668;&#x7684;&#x5730;&#x5740;&#x5bf9;&#x9f50;&#x529f;&#x80fd;&#x3002;CPU &#x8bfb;&#x53d6;&#x5185;&#x5b58;&#x901a;&#x5e38;&#x6309;&#x5757; (chuck) &#x8fdb;&#x884c;&#xff0c;&#x4f8b;&#x5982;&#x5728; x86 &#x67b6;&#x6784;&#x7684;&#x8ba1;&#x7b97;&#x673a;&#x4e0a;&#xff0c;&#x4e00;&#x4e2a; chuck &#x5927;&#x5c0f;&#x4e3a; 4 bytes&#xff08;&#x5373; 32 bits&#xff09;&#x3002;&#x4e3a;&#x4e86;&#x52a0;&#x901f; CPU &#x5bf9;&#x5c5e;&#x6027;&#x7684;&#x8bbf;&#x95ee;&#xff0c;&#x7f16;&#x8bd1;&#x5668;&#x4f1a;&#x5728;&#x5c5e;&#x6027;&#x95f4;&#x52a0;&#x5165;&#x65e0;&#x610f;&#x4e49;&#x7684;&#x5185;&#x5bb9;&#x3002;&#x5177;&#x4f53;&#x6765;&#x8bf4;&#xff0c;&#x4ee5; x86 &#x4e3a;&#x4f8b;&#xff1a;</li>
</ul>
<pre><code class="language-c">struct foo {
    char a;
    char b;
    /* 2-byte padding */
    int c;
};
</code></pre>
<p>&#x5355;&#x4e2a;&#x7ed3;&#x6784;&#x4f53;&#x5360;&#x7528;&#x7684;&#x5185;&#x5b58;&#x4e3a; 8 bytes&#xff0c;&#x800c;&#x4e0d;&#x662f; 1 + 1 + 4 = 6 bytes&#xff08;&#x53ef;&#x4ee5;&#x4f7f;&#x7528; gcc &#x7f16;&#x8bd1;&#xff0c;&#x6253;&#x5370; <code>sizeof(foo)</code> &#x8bd5;&#x4e00;&#x8bd5;&#xff09;&#x3002;&#x5982;&#x679c;&#x6ca1;&#x6709; padding&#xff0c;&#x5219;&#x8bfb;&#x53d6; <code>foo.c</code> &#x9700;&#x8981;&#x5206;&#x4e24;&#x6b21;&#xff08;&#x5148;&#x8bfb;&#x53d6;&#x7b2c;&#x4e00;&#x4e2a; chuck&#xff0c;&#x53d6;&#x540e;&#x4e24;&#x4e2a;&#x5b57;&#x8282;&#xff0c;&#x518d;&#x8bfb;&#x53d6;&#x7b2c;&#x4e8c;&#x4e2a; chuck&#xff0c;&#x53d6;&#x524d;&#x4e24;&#x4e2a;&#x5b57;&#x8282;&#xff0c;&#x62fc;&#x63a5;&#x5728;&#x4e00;&#x8d77;&#x5f62;&#x6210; <code>foo.c</code> &#xff09;&#xff1b;&#x6709;&#x4e86; padding &#x4e4b;&#x540e;&#xff0c;&#x8bfb;&#x53d6; <code>foo.c</code> &#x53ef;&#x4ee5;&#x4e00;&#x6b21;&#x6027;&#x5b8c;&#x6210;&#x3002;</p>
<ul>
<li>&#x5728; Linux &#x5185;&#x6838;&#x4e2d;&#xff0c;&#x5185;&#x6838;&#x7a7a;&#x95f4;&#x975e;&#x5e38;&#x5b9d;&#x8d35;&#xff0c;&#x56e0;&#x6b64;&#x6709;&#x65f6;&#x9700;&#x8981;&#x727a;&#x7272;&#x6548;&#x7387;&#xff0c;&#x4f7f;&#x7528; <code>__attribute__((packed))</code> &#x5173;&#x95ed;&#x8fd9;&#x4e00;&#x7279;&#x6027;&#x3002;</li>
<li>&#x53e6;&#x4e00;&#x4e2a;&#x76f8;&#x5173;&#x7684;&#x5c5e;&#x6027;&#x662f; <code>__attribute__((aligned(n)))</code> &#xff0c;&#x5176;&#x4e2d; <code>n</code> &#x4e3a;&#x6574;&#x6570;&#xff0c;&#x8868;&#x793a;&#x5c5e;&#x6027;&#x5e94;&#x8be5;&#x6309;&#x7167;&#x591a;&#x5c11;&#x4e2a;&#x5b57;&#x8282;&#x5bf9;&#x9f50;&#x3002;&#x4e0d;&#x96be;&#x770b;&#x51fa; <code>aligned(1)</code> &#x7b49;&#x4ef7;&#x4e8e; <code>packed</code>&#x3002;</li>
<li>&#x7f16;&#x8bd1;&#x5668;&#x8fd8;&#x652f;&#x6301;&#x4f2a;&#x6307;&#x4ee4; <code>#pragma pack(n)</code> &#x6765;&#x63cf;&#x8ff0;&#x8fd9;&#x4e00;&#x7279;&#x6027;&#x3002;&#x53ef;&#x4ee5;&#x4f7f;&#x7528; <code>#pragma ()</code> &#x6765;&#x53d6;&#x6d88;&#x8fd9;&#x4e00;&#x8bbe;&#x7f6e;&#x3002;&#x4f8b;&#x5982;&#xff1a;</li>
</ul>
<pre><code class="language-c">#pragma pack(1) // &#x53d6;&#x6d88; padding
struct foo {
    char a;
    char b;
    /* no padding */
    int c;
};
#pragma pack() // &#x6062;&#x590d;&#x9ed8;&#x8ba4;&#x8bbe;&#x7f6e;&#xff0c;&#x5373; 4 &#x5b57;&#x8282;&#x5bf9;&#x9f50;
</code></pre>
<h2>container_of</h2>
<p>&#x5728; Linux 5.14.12 &#x4e2d;&#xff0c;<code>container_of</code> &#x7684;&#x5b9a;&#x4e49;&#x4e3a;&#xff1a;</p>
<pre><code class="language-jsx">// from: /include/linux/kernel.h

/**
 * container_of - cast a member of a structure out to the containing structure
 * @ptr:	the pointer to the member.
 * @type:	the type of the container struct this is embedded in.
 * @member:	the name of the member within the struct.
 */
#define container_of(ptr, type, member) ({				\
    void *__mptr = (void *)(ptr);					\
    BUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)0)-&gt;member) &amp;&amp;	\
             !__same_type(*(ptr), void),			\
             &quot;pointer type mismatch in container_of()&quot;);	\
    ((type *)(__mptr - offsetof(type, member))); })
</code></pre>
<p>&#x8fd9;&#x4e2a;&#x5b8f;&#x7528;&#x4e8e;&#x83b7;&#x53d6; <code>ptr</code> &#x8fd9;&#x4e2a;<strong>&#x6307;&#x9488;&#x6240;&#x6307;&#x5411;&#x7684;&#x5bf9;&#x8c61;&#x5bf9;&#x5e94;&#x5c5e;&#x6027;&#x6240;&#x5c5e;&#x7684;&#x5bf9;&#x8c61;</strong>&#xff0c;&#x5b83;&#x88ab;&#x5927;&#x91cf;&#x5730;&#x7528;&#x4e8e; Linux &#x6e90;&#x4ee3;&#x7801;&#x4e2d;&#xff0c;&#x4f8b;&#x5982;&#xff1a;</p>
<pre><code class="language-c">// from: /fs/ext4/ext4.h
static inline struct ext4_inode_info *EXT4_I(struct inode *inode)
{
    return container_of(inode, struct ext4_inode_info, vfs_inode);
}
</code></pre>
<p>&#x8fd9;&#x4e2a;&#x4f8b;&#x5b50;&#x4e2d;&#xff0c;<code>*inode</code> &#x6240;&#x6307;&#x5411;&#x7684;&#x5bf9;&#x8c61;&#x5b9e;&#x9645;&#x4e0a;&#x662f; <code>struct ext4_inode_info</code> &#x7684;&#x4e00;&#x4e2a;&#x6210;&#x5458;&#xff0c;&#x5728;&#x7ed3;&#x6784;&#x4f53;&#x5185;&#xff0c;&#x8be5;&#x6210;&#x5458;&#x7684;&#x540d;&#x79f0;&#x4e3a; <code>vfs_inode</code> &#xff0c;&#x5373;&#xff1a;</p>
<pre><code class="language-c">struct ext4_inode_info {
    // ...
    struct inode vfs_inode;
    // ...
};
</code></pre>
<p>&#x4e0a;&#x9762;&#x5bf9; <code>container_of</code> &#x7684;&#x8c03;&#x7528;&#x5c06;&#x8fd4;&#x56de;&#x4e00;&#x4e2a;&#x6307;&#x5411;&#x7c7b;&#x578b;&#x4e3a; <code>ext4_inode_info</code> &#x7684;&#x5bf9;&#x8c61;&#x7684;&#x6307;&#x9488; <code>new_ptr</code>&#xff0c;&#x5b83;&#x6ee1;&#x8db3; <code>new_ptr-&gt;vfs_inode == *inode</code>&#x3002;</p>
<blockquote>
<p>&#x8fd9;&#x4e2a;&#x5b8f;&#x5728;&#x5185;&#x6838;&#x7684;&#x6570;&#x636e;&#x7ed3;&#x6784;&#x4e2d;&#x6709;&#x975e;&#x5e38;&#x91cd;&#x8981;&#x7684;&#x4f5c;&#x7528;&#xff0c;&#x4f8b;&#x5982;&#x5185;&#x6838;&#x4e2d;&#x5b9a;&#x4e49;&#x7684;&#x94fe;&#x8868;&#x7ed3;&#x6784;&#x5c31;&#x53cd;&#x590d;&#x4f7f;&#x7528;&#x4e86;&#x8fd9;&#x4e2a;&#x5b8f;&#x3002;</p>
</blockquote>
<p>&#x4e3a;&#x4e86;&#x7406;&#x89e3;&#x5176;&#x5de5;&#x4f5c;&#x539f;&#x7406;&#xff0c;&#x53bb;&#x9664;&#x4e2d;&#x95f4;&#x7684;&#x8c03;&#x8bd5;&#x4ee3;&#x7801;&#xff0c;&#x5e76;&#x5c06;&#x5b8f;&#x8f6c;&#x6362;&#x4e3a;&#x6613;&#x8bfb;&#x7684;&#x4f2a;&#x4ee3;&#x7801;&#xff08;&#x539f;&#x6765;&#x7684;&#x5b8f;&#x5b9a;&#x4e49;&#x6ca1;&#x6709; <code>return</code>&#xff0c;&#x56e0;&#x4e3a;&#x4f7f;&#x7528;&#x4e86; GNU C &#x7684;&#x4e00;&#x4e2a;<a href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Exprs.html">&#x62d3;&#x5c55;</a>&#xff0c;&#x5141;&#x8bb8;&#x5757;&#x4e2d;&#x6700;&#x540e;&#x4e00;&#x6761;&#x8868;&#x8fbe;&#x5f0f;&#x4f5c;&#x4e3a;&#x6574;&#x4e2a;&#x5757;&#x7684;&#x503c;&#x53c2;&#x4e0e;&#x8fd0;&#x7b97;&#xff09;&#xff0c;&#x5219;&#x5176;&#x5b9a;&#x4e49;&#x4e3a;&#xff1a;</p>
<pre><code class="language-c">container_of(ptr, type, member) {
    void *__mptr = (void *)(ptr);
    return ((type *)(__mptr - offsetof(type, member)));
}
</code></pre>
<p>&#x51fd;&#x6570;&#x4f53;&#x7b2c;&#x4e00;&#x884c;&#x9996;&#x5148;&#x5c06; <code>ptr</code> &#x8f6c;&#x6362;&#x4e3a;&#x4efb;&#x610f;&#x7c7b;&#x578b;&#x6307;&#x9488;&#xff0c;&#x4fbf;&#x4e8e;&#x540e;&#x7eed;&#x6307;&#x9488;&#x7684;&#x7b97;&#x6570;&#x8fd0;&#x7b97;&#xff1b;&#x7b2c;&#x4e8c;&#x884c;&#x8fd0;&#x7528;&#x5230;&#x4e86;&#x53e6;&#x4e00;&#x4e2a;&#x5b8f; <code>offsetof</code>&#xff08;&#x5f53;&#x7f16;&#x8bd1;&#x5668;&#x652f;&#x6301;&#x65f6;&#xff0c;&#x5373;&#x7b49;&#x4ef7;&#x4e8e; <code>__compiler_offsetof</code>&#xff1b;&#x5176;&#x5b9a;&#x4e49;&#x5728; <code>/include/linux/stddef.h</code>&#xff09;&#xff0c;&#x7528;&#x4e8e;&#x8ba1;&#x7b97;&#x7ed3;&#x6784;&#x4f53;&#x67d0;&#x4e2a;&#x53d8;&#x91cf;&#x76f8;&#x5bf9;&#x4e8e;&#x8d77;&#x59cb;&#x5730;&#x5740;&#x7684;&#x504f;&#x79fb;&#x91cf;&#x3002;&#x4f8b;&#x5982;&#xff1a;</p>
<pre><code class="language-c">struct foo {
    int a;
    int b;
};

offsetof(struct foo, a); // 0
offsetof(struct foo, b); // 4
</code></pre>
<ul>
<li><p>&#x5173;&#x4e8e; <code>offsetof</code> &#x7684;&#x5b9a;&#x4e49;</p>
<pre><code class="language-c">// from: /include/linux/stddef.h

#ifdef __compiler_offsetof
#define offsetof(TYPE, MEMBER)	__compiler_offsetof(TYPE, MEMBER)
#else
#define offsetof(TYPE, MEMBER)	((size_t)&amp;((TYPE *)0)-&gt;MEMBER)
#endif

// from: /include/linux/compiler_types.h
#define __compiler_offsetof(a, b)	__builtin_offsetof(a, b)
</code></pre>
<p>  <code>__builtin_offsetof</code> &#x5b9e;&#x9645;&#x4e0a;&#x76ee;&#x524d;&#x7248;&#x672c;&#x7684; GCC &#x548c; Clang &#x90fd;&#x652f;&#x6301;&#x3002;&#x5982;&#x679c;&#x7f16;&#x8bd1;&#x5668;&#x4e0d;&#x652f;&#x6301; <code>__builtin_offsetof</code>&#xff0c;&#x5219; <code>offsetof</code> &#x7684;&#x5b9e;&#x73b0; fallback &#x5230;&#x7a0b;&#x5e8f;&#x5458;&#x624b;&#x52a8;&#x8ba1;&#x7b97;&#x3002;&#x5728;&#x5927;&#x90e8;&#x5206;&#x7f16;&#x8bd1;&#x5668;&#x4e0a;&#xff0c;&#x7f16;&#x8bd1;&#x5668;&#x5185;&#x7f6e;&#x5b9e;&#x73b0;&#x548c;&#x624b;&#x52a8;&#x8ba1;&#x7b97;&#x5e76;&#x65e0;&#x5dee;&#x5f02;&#xff0c;&#x90fd;&#x80fd;&#x5b9e;&#x73b0;&#x7f16;&#x8bd1;&#x65f6;&#x8ba1;&#x7b97;&#xff0c;&#x4f46;&#x540e;&#x8005;&#x5b9e;&#x9645;&#x4e0a;&#x5e76;&#x975e;&#x786e;&#x5b9a;&#x7684;&#x884c;&#x4e3a;&#xff0c;&#x5373;&#x5728;&#x67d0;&#x4e9b;&#x7f16;&#x8bd1;&#x5668;&#x4e0a;&#xff0c;&#x8fd9;&#x4e2a;&#x503c;&#x4e5f;&#x53ef;&#x80fd;&#x662f;&#x8fd0;&#x884c;&#x65f6;&#x8ba1;&#x7b97;&#x7684;&#xff08;&#x89c1; <a href="https://stackoverflow.com/questions/1379298/offsetof-at-compile-time">Reference</a>&#xff09;&#xff0c;&#x6545; Linux &#x6e90;&#x4ee3;&#x7801;&#x63d0;&#x4f9b;&#x4e86;&#x4e24;&#x79cd;&#x5b9e;&#x73b0;&#xff0c;&#x6ca1;&#x6709;&#x76f4;&#x63a5; default &#x5230;&#x624b;&#x52a8;&#x8ba1;&#x7b97;&#x3002;</p>
</li>
</ul>
<h2>__randomize_layout</h2>
<p>&#x653b;&#x51fb;&#x8005;&#x53ef;&#x80fd;&#x4f1a;&#x5229;&#x7528;&#x7ed3;&#x6784;&#x4f53;&#x5c5e;&#x6027;&#x7684;&#x5185;&#x5b58;&#x6392;&#x5e03;&#x53d1;&#x8d77;&#x653b;&#x51fb;&#xff0c;&#x4f8b;&#x5982;&#xff1a;</p>
<pre><code class="language-jsx">struct foo {
    int val;
    int *important_fn(void *args);
} global_var;

// &#x653b;&#x51fb;&#x8005;&#xff1a;&#xff08;&#x4ec5;&#x793a;&#x610f;&#xff09;
extern int *malicious_fn(void *args);
memcpy((void *)global_var + 4, malicious_fn);

// &#x6b64;&#x65f6; global_var &#x4e2d;&#x7684; important_fn &#x6307;&#x9488;&#x5df2;&#x88ab;&#x8986;&#x76d6;&#xff0c;
// &#x6307;&#x5411;&#x653b;&#x51fb;&#x8005;&#x7684; malicious_fn&#xff1b;
// &#x7cfb;&#x7edf;&#x7684;&#x540e;&#x7eed;&#x4ee3;&#x7801;&#xff1a;
global_var-&gt;important_fn(args); // &#x5bfc;&#x81f4;&#x6076;&#x610f;&#x51fd;&#x6570;&#x88ab;&#x8c03;&#x7528;
                                // &#x906d;&#x5230;&#x653b;&#x51fb;&#xff01;
</code></pre>
<p>&#x4e3a;&#x4e86;&#x907f;&#x514d;&#x8fd9;&#x79cd;&#x653b;&#x51fb;&#xff0c;Linux &#x4f7f;&#x7528;&#x4e86; gcc <code>randstruct</code> &#x63d2;&#x4ef6;&#x6765;&#x5141;&#x8bb8;&#x7f16;&#x8bd1;&#x5668;&#x5c06;&#x7ed3;&#x6784;&#x4f53;&#x5185;&#x5c5e;&#x6027;&#x7684;&#x5185;&#x5b58;&#x6392;&#x5e03;&#x968f;&#x673a;&#x6253;&#x4e71;&#xff0c;&#x6253;&#x4e71;&#x7ed3;&#x679c;&#x7531; seed &#x552f;&#x4e00;&#x786e;&#x5b9a;&#x3002;&#x6b64;&#x63d2;&#x4ef6;&#x7684;&#x4e09;&#x4e2a;&#x4e3b;&#x8981;&#x529f;&#x80fd;&#xff1a;</p>
<ol>
<li>&#x4efb;&#x4f55;&#x6807;&#x8bb0;&#x6709; <code>__randomize_layout</code>  &#xff08;&#x5b9e;&#x9645;&#x4e0a;&#x5c31;&#x662f; <code>__attribute__((randomize_layout))</code> &#xff0c;&#x8fd9;&#x91cc;&#x53c8;&#x662f; Linux &#x7684;&#x4e00;&#x4e2a;&#x5b8f;&#x5b9a;&#x4e49;&#xff09;&#x7684;&#x7ed3;&#x6784;&#x4f53;&#x90fd;&#x5c06;&#x968f;&#x673a;&#x5e03;&#x5c40;&#x3002;</li>
<li>&#x5728;&#x6253;&#x5f00;&#x4e86; <code>randstruct</code> &#x7684;&#x7f16;&#x8bd1;&#x8fc7;&#x7a0b;&#xff0c;&#x5bf9;&#x4e8e;&#x6240;&#x6709;&#x6210;&#x5458;&#x5c5e;&#x6027;&#x5747;&#x4e3a;&#x51fd;&#x6570;&#x6307;&#x9488;&#x7684;&#x7ed3;&#x6784;&#x4f53;&#xff0c;&#x968f;&#x673a;&#x5e03;&#x5c40;&#x4f1a; <em>&#x81ea;&#x52a8;</em> &#x6253;&#x5f00;&#x3002;</li>
<li>&#x53ef;&#x4ee5;&#x4f7f;&#x7528; <code>__no_randomize_layout</code> &#x663e;&#x5f0f;&#x5173;&#x95ed;&#x968f;&#x673a;&#x5e03;&#x5c40;&#xff08;<a href="https://lwn.net/Articles/722293/">Reference</a> &#x7ed9;&#x51fa;&#x4e86;&#x9700;&#x8981;&#x5173;&#x95ed;&#x6b64;&#x529f;&#x80fd;&#x7684;&#x6848;&#x4f8b;&#xff09;&#x3002;</li>
</ol>
<blockquote>
<p>&#x6709;&#x4e9b;&#x8bfb;&#x8005;&#x53ef;&#x80fd;&#x4f1a;&#x60f3;&#x5230;&#x53ef;&#x4ee5;&#x5728;&#x4e0a;&#x9762;&#x7684;&#x4ee3;&#x7801;&#x4e2d;&#x4f7f;&#x7528; <code>offsetof</code> &#x6765;&#x8ba1;&#x7b97;&#x504f;&#x79fb;&#x91cf;&#xff0c;&#x4ece;&#x800c;&#x7834;&#x89e3;&#x968f;&#x673a;&#x5e03;&#x5c40;&#x673a;&#x5236;&#xff0c;&#x7136;&#x800c; <code>offsetof</code> &#x662f;&#x7f16;&#x8bd1;&#x65f6;&#x7684;&#x673a;&#x5236;&#xff0c;&#x800c;&#x653b;&#x51fb;&#x8005;&#x653b;&#x51fb;&#x7684;&#x662f;&#x7f16;&#x8bd1;&#x540e;&#x7684;&#x4e8c;&#x8fdb;&#x5236;&#xff0c;&#x65e0;&#x6cd5;&#x8c03;&#x7528; <code>offsetof</code> &#x3002;&#x4e0a;&#x9762;&#x7684;&#x653b;&#x51fb;&#x8005;&#x4ee3;&#x7801;&#x53ea;&#x662f;&#x4e3a;&#x4e86;&#x6f14;&#x793a;&#x653b;&#x51fb;&#x5927;&#x6982;&#x5982;&#x4f55;&#x53d1;&#x751f;&#x3002;&#xff08;&#x53e6;&#xff1a;&#x6253;&#x5f00;&#x968f;&#x673a;&#x5e03;&#x5c40;&#x540e;&#xff0c;<code>offsetof</code> &#x7684;&#x8f93;&#x51fa;&#x4e5f;&#x4f1a;&#x662f;&#x7b26;&#x5408;&#x968f;&#x673a;&#x7ed3;&#x679c;&#x7684;&#xff0c;&#x56e0;&#x6b64;&#x4e0d;&#x4f1a;&#x7834;&#x574f; <code>container_of</code> &#x7b49;&#x5b8f;&#x7684;&#x6b63;&#x786e;&#x6027;&#x3002;&#xff09;</p>
</blockquote>
<p>&#x7136;&#x800c;&#x8fd9;&#x4e2a;&#x65b9;&#x6848;&#x5bf9;&#x4e8e;&#x516c;&#x5f00;&#x5206;&#x53d1;&#x7684; Linux &#x5185;&#x6838;&#x5e2e;&#x52a9;&#x751a;&#x5c0f;&#xff0c;&#x56e0;&#x4e3a;&#x8fd9;&#x4e9b;&#x5185;&#x6838;&#x5fc5;&#x987b;&#x516c;&#x5f00;&#x81ea;&#x5df1;&#x4f7f;&#x7528;&#x7684; seed &#x6765;&#x5141;&#x8bb8;&#x7b2c;&#x4e09;&#x65b9;&#x5185;&#x6838;&#x6a21;&#x5757;&#x5728;&#x5185;&#x6838;&#x4e0a;&#x8fd0;&#x884c;&#x3002;&#x5b9e;&#x9645;&#x4e0a;&#x80fd;&#x591f;&#x4ece;&#x8fd9;&#x4e00;&#x65b9;&#x6848;&#x4e2d;&#x53d7;&#x76ca;&#x7684;&#x662f;&#x90a3;&#x4e9b;&#x975e;&#x516c;&#x5f00;&#x7684; Linux &#x5185;&#x6838;&#xff0c;&#x4f8b;&#x5982; Google &#x548c; Facebook &#x8fd0;&#x884c;&#x4e8e;&#x670d;&#x52a1;&#x5668;&#x4e0a;&#x7684;&#x5185;&#x6838;&#x3002;&#xff08;&#x89c1; <a href="https://lwn.net/Articles/722293/">Reference</a>&#xff09;</p>
<h2>Sparse</h2>
<p>&#x9664;&#x4e86;&#x4e0a;&#x9762;&#x8bf4;&#x5230;&#x7684;&#x8fd9;&#x4e9b;&#x5c5e;&#x6027;&#x4ee5;&#x5916;&#xff0c;&#x8fd8;&#x6709;&#x4e00;&#x4e9b; GCC &#x4f1a;&#x76f4;&#x63a5;&#x5ffd;&#x7565;&#x7684;&#x5c5e;&#x6027;&#xff0c;&#x5b83;&#x4eec;&#x88ab; Linus &#x5f00;&#x53d1;&#x7684; Sparse &#xff08;&#x89c1; <a href="https://lwn.net/Articles/689907/">Reference</a>&#xff09;&#x9759;&#x6001;&#x5206;&#x6790;&#x5de5;&#x5177;&#x5229;&#x7528;&#x3002;&#x4f8b;&#x5982; <code>__user</code> &#x7684;&#x5b9a;&#x4e49;&#xff1a;</p>
<pre><code class="language-jsx">// /include/linux/compiler_types.h
# define __user		__attribute__((noderef, address_space(__user)))
</code></pre>
<p>&#x4e5f;&#x5c31;&#x662f;&#x8bf4;&#xff0c;__user &#x6709;&#x4e24;&#x5c42;&#x542b;&#x4e49;&#xff1a;<code>noderef</code> &#x8868;&#x793a;&#x4ee3;&#x7801;&#x4e2d;&#x4e0d;&#x5e94;&#x8be5;&#x76f4;&#x63a5;&#x89e3;&#x5f15;&#x7528;&#x4f7f;&#x7528; <code>__user</code> &#x4fee;&#x9970;&#x7684;&#x6307;&#x9488;&#xff0c;&#x4ee5;&#x53ca;&#x4fee;&#x9970;&#x7684;&#x6307;&#x9488;&#x6307;&#x5411;&#x7528;&#x6237;&#x7a7a;&#x95f4;&#x5185;&#x5b58;&#x3002;&#x7531;&#x4e8e;&#x5185;&#x6838;&#x80fd;&#x591f;&#x4efb;&#x610f;&#x5730;&#x8bbf;&#x95ee;&#x5185;&#x5b58;&#xff0c;&#x4f7f;&#x7528; __user &#x9650;&#x5b9a;&#x7b26;&#x6765;&#x63d0;&#x9192;&#x5f00;&#x53d1;&#x8005;&#x4e0d;&#x8981;&#x53bb;&#x8bbf;&#x95ee;&#x4e0d;&#x53d7;&#x4fe1;&#x4efb;&#x7684;&#x5185;&#x5b58;&#xff0c;&#x4e43;&#x81f3;&#x540e;&#x7eed;&#x4f7f;&#x7528;&#x4ee3;&#x7801;&#x68c0;&#x67e5;&#x6765;&#x907f;&#x514d;&#x6709;&#x5173;&#x6f0f;&#x6d1e;&#x8fdb;&#x5165;&#x4e3b;&#x7ebf;&#xff0c;&#x662f;&#x975e;&#x5e38;&#x6709;&#x76ca;&#x5904;&#x7684;&#x3002;&#x5f00;&#x53d1;&#x8005;&#x4f7f;&#x7528; Sparse &#x5bf9;&#x4ee3;&#x7801;&#x8fdb;&#x884c;&#x68c0;&#x67e5;&#x65f6;&#xff0c;&#x5982;&#x679c;&#x53d1;&#x751f;&#x4e86;&#x8fdd;&#x53cd;&#x8fd9;&#x4e24;&#x79cd;&#x60c5;&#x51b5;&#x7684;&#x4ee3;&#x7801;&#xff0c;&#x4f1a;&#x6536;&#x5230;&#x62a5;&#x544a;&#x3002;&#x53ef;&#x4ee5;&#x4f7f;&#x7528; <code>make C=2</code> &#x6765;&#x5bf9;&#x4ee3;&#x7801;&#x8fdb;&#x884c;&#x68c0;&#x67e5;&#x3002;</p>

  </article>
</main>
    <footer class="flex">
  <a href="/">&#xa9; Harlan V. Wei (aka. Wei Chen)</a>
  <strong></strong>
</footer>
  </body>

</html>